#!/bin/bash

set -euo pipefail

# Install dependencies
sudo apt-get update && sudo apt-get upgrade -y
sudo apt install -y curl iptables build-essential git wget lz4 jq make cmake gcc nano automake autoconf tmux htop nvme-cli libgbm1 pkg-config libssl-dev libleveldb-dev tar clang bsdmainutils ncdu unzip libleveldb-dev screen ufw

# Install Rust
curl https://sh.rustup.rs -sSf | sh -s -- -y
source "$HOME/.cargo/env"
rustc --version || echo "Rust installation failed"

# Install Go
wget https://go.dev/dl/go1.24.3.linux-amd64.tar.gz
sudo rm -rf /usr/local/go
sudo tar -C /usr/local -xzf go1.24.3.linux-amd64.tar.gz
rm go1.24.3.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc

# Clone 0g-storage-node repo
if [ -d "$HOME/0g-storage-node" ]; then
    echo "‚ö†Ô∏è  Directory '0g-storage-node' already exists."
    read -p "Do you want to delete it and re-clone? (y/n): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        rm -rf "$HOME/0g-storage-node"
    else
        echo "Skipping clone..."
    fi
fi

if [ ! -d "$HOME/0g-storage-node" ]; then
    git clone https://github.com/0glabs/0g-storage-node.git
    cd 0g-storage-node
    git checkout v1.0.0
    git submodule update --init
    cargo build --release
    cd ..
fi

# Download config
CONFIG_PATH="$HOME/0g-storage-node/run/config.toml"
mkdir -p "$(dirname "$CONFIG_PATH")"
curl -o "$CONFIG_PATH" https://raw.githubusercontent.com/mohsinsmsn/0gnode/refs/heads/main/config.toml

# Prompt for private key (without 0x)
exec < /dev/tty
echo ""
read -e -p "üëâ Enter your private key (64 hex chars, no '0x'): " PRIVATE_KEY

while [[ ! "$PRIVATE_KEY" =~ ^[a-fA-F0-9]{64}$ ]]; do
  echo "‚ùå Invalid format. Enter 64-character hex private key without '0x'"
  read -e -p "Re-enter private key: " PRIVATE_KEY
done

# Insert or replace miner_key
if grep -q "^miner_key" "$CONFIG_PATH"; then
    sed -i "s|^miner_key.*|miner_key = \"$PRIVATE_KEY\"|" "$CONFIG_PATH"
else
    echo "miner_key = \"$PRIVATE_KEY\"" >> "$CONFIG_PATH"
fi
echo "‚úÖ Private key set."

# Prompt user to choose RPC
echo -e "\nAvailable RPCs:"
RPC_LIST=(
"https://0g-evm-rpc.zeycanode.com/"
"https://evmrpc-testnet.0g.ai"
"https://0g-testnet-rpc.astrostake.xyz"
"https://lightnode-json-rpc-0g.grandvalleys.com"
"https://0g-galileo-evmrpc.corenodehq.xyz/"
"https://0g.json-rpc.cryptomolot.com/"
"https://0g-evm.maouam.nodelab.my.id/"
"https://0g-evmrpc-galileo.coinsspor.com/"
"https://0g-evmrpc-galileo.komado.xyz/"
"https://0g.galileo.zskw.xyz/"
"https://0g-galileo.shachopra.com/"
"https://0g-galileo-evmrpc2.corenodehq.xyz/"
"http://0g-galileo-evm-rpc.validator247.com/"
"https://evmrpc.vinnodes.com/"
"https://0g-galileo-ferdimanaa.xyz/"
"https://0g-galileo.xzid.xyz/"
)

for i in "${!RPC_LIST[@]}"; do
    printf "%2d) %s\n" $((i+1)) "${RPC_LIST[$i]}"
done

read -p "Enter the number of the RPC you want to use: " RPC_CHOICE
CHOSEN_RPC="${RPC_LIST[$((RPC_CHOICE - 1))]}"

# Insert or update blockchain_rpc_endpoint
if grep -q "^blockchain_rpc_endpoint" "$CONFIG_PATH"; then
    sed -i "s|^blockchain_rpc_endpoint.*|blockchain_rpc_endpoint = \"$CHOSEN_RPC\"|" "$CONFIG_PATH"
else
    echo "blockchain_rpc_endpoint = \"$CHOSEN_RPC\"" >> "$CONFIG_PATH"
fi
echo "‚úÖ RPC set to $CHOSEN_RPC"

# Create systemd service
sudo tee /etc/systemd/system/zgs.service > /dev/null <<EOF
[Unit]
Description=ZGS Node
After=network.target

[Service]
User=$USER
WorkingDirectory=$HOME/0g-storage-node/run
ExecStart=$HOME/0g-storage-node/target/release/zgs_node --config $CONFIG_PATH
Restart=on-failure
RestartSec=10
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

# Start the service
sudo systemctl daemon-reload
sudo systemctl enable zgs
sudo systemctl start zgs

echo -e "\nüöÄ ZGS Node has been installed and started successfully!"
